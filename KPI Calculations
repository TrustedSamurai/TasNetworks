/***************************************************************
 * 
 * KPI Calculation Script. 
 *
 * - High Potential Incident Count 		- "High Potential Incident Flag"
 * - TRIFR Injury Count					- "TRIFR Injury Flag"
 * - Reportable Safety Incident Count	- "Reportable Safety Event Flag"
 * - Significant Event Count			- "Significant Incident Flag"
 *  
 */
CREATE VIEW Calculated_KPI_Results as  
  /* 
  * Calculate the High Potential Incidents  
  */
SELECT DISTINCT 
	EVENTS."EventID"
	, 'High Potential Incident Flag' AS "KPI Name"
	, CASE 
		WHEN EVENT_GROUPS."EventID" IS NOT null THEN 1 
		ELSE 0 
	  END AS "KPI Numerator" 
	, 1 AS "KPI Denominator"
	, CASE 
		WHEN EVENT_GROUPS."EventID" IS NOT null THEN concat('Potential Consequence Rating - ',EVENT_GROUPS."Potential Consequence Rating" ) 
		ELSE '' 
	  END	AS "KPI Contextual Message"
	, 'HPI is a People & Safety Near Miss with a consequence rating of Major or Severe - meets HSE KPI Reporting specifications' AS "KPI Description"
FROM EHS_DA_DMART.ER_EVENTANALYSIS_BASIC_GROUPS AS EVENTS
LEFT OUTER JOIN EHS_DA_DMART.EVENTS_GROUPS_VW AS EVENT_GROUPS 
			ON EVENTS."EventID" = EVENT_GROUPS."EventID" 
			AND EVENT_GROUPS."Group Name" = 'People & Safety'  /* People/Safety events only */
			AND EVENT_GROUPS."Potential Consequence Rating" IN ('4 - Major','5 - Severe') /* Potential Consequence is Significant */
WHERE EVENTS."EventStatus" <> '00' /* ignore Voided events */
  AND EVENTS."EventType" = 'N' /* ONLY include Near Misses */
  AND EVENTS."PrimaryInvolvement"  IN ('X','') /* ONLY include WHERE PRIMARY Involvement IS TasNetworks or Contractor */ 
  /* 
  * Calculate the TRIFR Injury count based on the KPI calculation rules for 2021-22
  */
 UNION 
 SELECT DISTINCT 
	EVENTS."EventID"
	, 'TRIFR Injury Flag' AS "KPI Name"
	, CASE 
		WHEN INJURIES."EventID" IS NOT null THEN 1 
		ELSE 0 
	  END AS "KPI Numerator" 
	, 1 AS "KPI Denominator"
	, CASE 
		WHEN INJURIES."EventID" IS NOT null THEN concat ( 'Compensable Recordable - ', INJURIES."InjuredPersonInjuryClsDesc" )
		ELSE '' 
	  END AS "KPI Contextual Message"
	, 'Identifies where a TRIFR related injury was recorded - meets HSE KPI Reporting specifications' AS "KPI Description"
 FROM EHS_DA_DMART.ER_EVENTANALYSIS_BASIC_GROUPS AS EVENTS
 LEFT OUTER JOIN EHS_DA_DMART.INJUREDPERSONS_VW AS INJURIES 
			 ON EVENTS."EventID" = INJURIES."EventID" 
			 AND INJURIES."InjuryIncidentType" = 'Compensable Recordable'
			 AND INJURIES."InjuredPersonInjuryClsDesc" IN ('Medical Treatment Injury','Lost Time Injury','Restricted Work Injury')
 WHERE EVENTS."EventStatus" <> '00' /* ignore Voided events */
   AND EVENTS."EventType" = 'I' /* ONLY include Incidents */
   AND EVENTS."PrimaryInvolvement"  = 'X' /* ONLY include WHERE PRIMARY Involvement IS TasNetworks */
 UNION
  /* 
  * Calculate the Reportable Safety Events based on the KPI calculation rules for 2021-22
  */
 SELECT DISTINCT 
	EVENTS."EventID"
	, 'Reportable Safety Event Flag' AS "KPI Name"
	, CASE 
		WHEN NonCompliance."EventID" IS NOT null 
		AND "GroupINC_GROUP" = 'EHHSS_IGR_NOT_OF_VIOL' THEN 1 	/* Compliance incident - violation type NERR affecting a Life Support Customer */ 
		WHEN WorkSafeTas."EventID" IS NOT null  THEN 1 	/* Reported to WorkSafe Tasmania */ 
		ELSE 0
	  END AS "KPI Numerator" 
	, 1 AS "KPI Denominator"
	, CASE 
		WHEN NonCompliance."EventID" IS NOT null 
		AND "GroupINC_GROUP" = 'EHHSS_IGR_NOT_OF_VIOL' THEN 'AER - Compliance - NERR Life Support Customer' 	/* Compliance incident - violation type NERR affecting a Life Support Customer */ 
		WHEN WorkSafeTas."EventID" IS NOT null  THEN 'WorkSafe - PeopleSafety' 	/* Reported to WorkSafe Tasmania */ 
		ELSE ''
	  END AS "KPI Contextual Message"
	, 'Identifies where an event has been reported to Worksafe or AER(for lifesupport) has occurred - meets HSE KPI Reporting specifications' AS "KPI Description"
FROM EHS_DA_DMART.ER_EVENTANALYSIS_BASIC_GROUPS AS EVENTS
LEFT JOIN 
			(
				SELECT DISTINCT "EventID" AS "EventID" 
				FROM EHS_DA_DMART.ER_EVENTANALYSIS_NONCOMPLIANCE 
				WHERE ("ViolationType" = 'ZEHHSS_VTC_LSCINTERRU'
				OR "ReqREQ_ID" IN (
									 '50001840' /* Distributor de-energisation of premises-small customers, from here down */
									,'50001843'
									,'50005268' /* Distributor obligations, life support equipment, from here down */
									,'50005258'
									,'50005259'
									,'50005260'
									,'50005261'
									,'50005262'
									,'50005263'
									,'50005264'
									,'50005265'
									,'50005266'
									,'50005267'
									,'50005268'
									,'50005269'
									,'50005270'
									,'50005271'
									,'50005272'
									,'50005274'
									,'50005276'
									,'50005277'
									,'50005278'
									,'50005280'
								  ) 
					   )
			) AS NonCompliance ON EVENTS."EventID" = NonCompliance."EventID"
LEFT JOIN 
			(
				SELECT DISTINCT EVENTDETAILS."EventID" AS "EventID" 
				FROM EHS_DA_DMART.ER_EVENTANALYSIS_BASIC_GROUPS AS EVENTDETAILS
				LEFT OUTER JOIN EHS_DA_DMART.ER_EVENTANALYSIS_NONCOMPLIANCE AS COMPLIANCE  ON EVENTDETAILS."EventID" = COMPLIANCE."EventID" 
				WHERE COMPLIANCE."RegulatorDESCRIPTION" = 'WorkSafe Tasmania'
				   OR EVENTDETAILS."RegulatorREGULATION" = 'ZWST'  /* Look for Worksafe Tas regulator details in Event table if missing from compliance table */
			) AS WorkSafeTas ON EVENTS."EventID" = WorkSafeTas."EventID"
WHERE EVENTS."EventStatus" <> '00' /* ignore Voided events */
  AND EVENTS."EventType" IN ('I', 'N') /* include Incidents & near misses */
  AND EVENTS."PrimaryInvolvement"  = 'X' /* ONLY include WHERE PRIMARY Involvement IS TasNetworks */  
 UNION 
  /* 
   * Calculate the Signficant Incidents based on the KPI calculation rules for 2021-22
  */
SELECT DISTINCT 
	EVENTS."EventID"
	, 'Significant Incident Flag' AS "KPI Name"
	, CASE 
		WHEN NonCompliance."EventID" IS NOT null 
		 AND  "GroupINC_GROUP" = 'EHHSS_IGR_NOT_OF_VIOL'
		 AND  "GroupZZACTUAL_CONS" IN ('03','04','05') THEN 1 
		WHEN  "GroupINC_GROUP" = 'EHHSS_IGR_OCC_INC'/* People-Safety incident,  / Potential Consequence Rating Major or Severe */
		 AND  "GroupZZPOTENTIAL_CONS" IN ('04','05') THEN 1 
		ELSE 0 
	  END AS "KPI Numerator" 
	, 1 AS "KPI Denominator"
	, CASE 
		WHEN NonCompliance."EventID" IS NOT null 
		 AND  "GroupINC_GROUP" = 'EHHSS_IGR_NOT_OF_VIOL'
		 AND  "GroupZZACTUAL_CONS" IN ('03','04','05') THEN concat('Compliance - with Actual Consequece rating of ', ActualCons.TXTLG )
		WHEN  "GroupINC_GROUP" = 'EHHSS_IGR_OCC_INC'/* People-Safety incident,  / Potential Consequence Rating Major or Severe */
		 AND  "GroupZZPOTENTIAL_CONS" IN ('04','05') THEN concat('People & Safety incident with potential consequence rating of ', PotentialCons.TXTLG )
		ELSE ''
	  END AS "KPI Contextual Message"
	, 'Identifies where a Significant Incident has occurred - meets HSE KPI Reporting specifications' AS "KPI Description"
FROM EHS_DA_DMART.ER_EVENTANALYSIS_BASIC_GROUPS AS EVENTS
LEFT JOIN 
			(
				SELECT DISTINCT "EventID" AS "EventID" 
				FROM EHS_DA_DMART.ER_EVENTANALYSIS_NONCOMPLIANCE 
				WHERE ("ViolationType" = 'ZEHHSS_VTC_LSCINTERRU'
				OR "ReqREQ_ID" IN (
									 '50001840' /* Distributor de-energisation of premises-small customers, from here down */
									,'50001843'
									,'50005268' /* Distributor obligations, life support equipment, from here down */
									,'50005258'
									,'50005259'
									,'50005260'
									,'50005261'
									,'50005262'
									,'50005263'
									,'50005264'
									,'50005265'
									,'50005266'
									,'50005267'
									,'50005268'
									,'50005269'
									,'50005270'
									,'50005271'
									,'50005272'
									,'50005274'
									,'50005276'
									,'50005277'
									,'50005278'
									,'50005280'
								  ) 
					   )
			) AS NonCompliance ON EVENTS."EventID" = NonCompliance."EventID"
LEFT OUTER JOIN EHS_DA_DMART."PotentialConsqCode" AS ActualCons ON EVENTS."GroupZZACTUAL_CONS" = ActualCons."Code" 
LEFT OUTER JOIN EHS_DA_DMART."PotentialConsqCode" AS PotentialCons ON EVENTS."GroupZZPOTENTIAL_CONS" = PotentialCons."Code" 
WHERE EVENTS."EventStatus" <> '00' /* ignore Voided events */
  AND EVENTS."EventType" = 'I' /* ONLY include Incidents */
  AND EVENTS."PrimaryInvolvement"  = 'X' /* ONLY include WHERE PRIMARY Involvement IS TasNetworks */

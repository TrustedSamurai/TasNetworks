/* Build Event Groups table from the main Events Table */
CREATE VIEW Events_Groups_vw AS
SELECT MANDT
	, "IncidentRootDB_KEY"
	, EVENTGROUPS."EventID"
	, "GroupINC_GROUP"
	, CASE 
		WHEN "GroupINC_GROUP" = 'ZEHHSS_IGR_ASSET' 		THEN 'Assets' 
		WHEN "GroupINC_GROUP" = 'EHHSS_IGR_NOT_OF_VIOL' THEN 'Non-Compliance' 
		WHEN "GroupINC_GROUP" = 'EHHSS_IGR_RELEASE' 	THEN 'Environment' 
		WHEN "GroupINC_GROUP" = 'EHHSS_IGR_OCC_INC' 	THEN 'People & Safety' 
		ELSE "GroupINC_GROUP" 
	  END AS "Group Name" 
	, "LocationID"
	, "GroupZZACTUAL_CONS"
	, CASE 
		WHEN "GroupZZACTUAL_CONS" = '01' 				THEN '1 - Negligible' 
		WHEN "GroupZZACTUAL_CONS" = '02' 				THEN '2 - Minor' 
		WHEN "GroupZZACTUAL_CONS" = '03' 				THEN '3 - Moderate' 
		WHEN "GroupZZACTUAL_CONS" = '04' 				THEN '4 - Major' 
		WHEN "GroupZZACTUAL_CONS" = '05' 				THEN '5 - Severe' 
		ELSE 'unassigned' 
	  END AS "Actual Consequence Rating" 
	, "GroupZZPOTENTIAL_CONS"
	, CASE 
		WHEN "GroupZZPOTENTIAL_CONS" = '01' 			THEN '1 - Negligible' 
		WHEN "GroupZZPOTENTIAL_CONS" = '02' 			THEN '2 - Minor' 
		WHEN "GroupZZPOTENTIAL_CONS" = '03' 			THEN '3 - Moderate' 
		WHEN "GroupZZPOTENTIAL_CONS" = '04' 			THEN '4 - Major' 
		WHEN "GroupZZPOTENTIAL_CONS" = '05' 			THEN '5 - Severe' 
		ELSE 'unassigned' 
	  END AS "Potential Consequence Rating" 
	, CASE 
		WHEN NonCompliance."EventID" IS NOT null  	/* Compliance incident, violation type NERR / Life Support Customer / Actual Consequence Rating Moderate or Above */
		 AND "GroupINC_GROUP" = 'EHHSS_IGR_NOT_OF_VIOL'
		 AND  "GroupZZACTUAL_CONS" IN ('03','04','05') THEN 'Yes' 
		WHEN  "GroupINC_GROUP" = 'EHHSS_IGR_OCC_INC'/* People-Safety incident,  / Potential Consequence Rating Major or Severe */
		 AND  "GroupZZPOTENTIAL_CONS" IN ('04','05') THEN 'Yes' 
		ELSE 'No' 
	  END AS "Significant Incident" 
	, CASE 
		WHEN NonCompliance."EventID" IS NOT null 
		AND "GroupINC_GROUP" = 'EHHSS_IGR_NOT_OF_VIOL' THEN 'Yes' 	/* Compliance incident - violation type NERR affecting a Life Support Customer */ 
		WHEN WorkSafeTas."EventID" IS NOT null  THEN 'Yes' 	/* Reported to WorkSafe Tasmania */ 
		ELSE ''
	  END AS "Reportable Safety Incident"
	, CASE 
		WHEN NonCompliance."EventID" IS NOT null 
		AND "GroupINC_GROUP" = 'EHHSS_IGR_NOT_OF_VIOL' THEN 'Interruption LSC' 	/* Compliance incident - violation type NERR affecting a Life Support Customer */ 
		WHEN WorkSafeTas."EventID" IS NOT null 
		AND "GroupINC_GROUP" = 'EHHSS_IGR_OCC_INC' THEN 
			CASE 
				WHEN "GroupINC_GROUP" = 'ZEHHSS_IGR_ASSET' 		THEN 'Assets' 
				WHEN "GroupINC_GROUP" = 'EHHSS_IGR_NOT_OF_VIOL' THEN 'Non-Compliance' 
				WHEN "GroupINC_GROUP" = 'EHHSS_IGR_RELEASE' 	THEN 'Environment' 
				WHEN "GroupINC_GROUP" = 'EHHSS_IGR_OCC_INC' 	THEN 'People & Safety' 
				ELSE "GroupINC_GROUP" 
			  END 
		ELSE ''
	  END AS "Reportable Safety Incident Type"
FROM EHS_DA_DMART.ER_EVENTANALYSIS_BASIC_GROUPS AS EventGroups
LEFT JOIN 
			(
				SELECT DISTINCT "EventID" AS "EventID" 
				FROM EHS_DA_DMART.ER_EVENTANALYSIS_NONCOMPLIANCE 
				WHERE ("ViolationType" = 'ZEHHSS_VTC_LSCINTERRU'
				OR "ReqREQ_ID" IN (
									 '50001840' /* Distributor de-energisation of premises-small customers, from here down */
									,'50001843'
									,'50005268' /* Distributor obligations, life support equipment, from here down */
									,'50005258'
									,'50005259'
									,'50005260'
									,'50005261'
									,'50005262'
									,'50005263'
									,'50005264'
									,'50005265'
									,'50005266'
									,'50005267'
									,'50005268'
									,'50005269'
									,'50005270'
									,'50005271'
									,'50005272'
									,'50005274'
									,'50005276'
									,'50005277'
									,'50005278'
									,'50005280'
								  ) 
					   )
			) AS NonCompliance ON EVENTGROUPS."EventID" = NonCompliance."EventID"
LEFT JOIN 
			(
				SELECT DISTINCT EVENTDETAILS."EventID" AS "EventID" 
				FROM EHS_DA_DMART.ER_EVENTANALYSIS_BASIC_GROUPS AS EVENTDETAILS
				LEFT OUTER JOIN EHS_DA_DMART.ER_EVENTANALYSIS_NONCOMPLIANCE AS COMPLIANCE  ON EVENTDETAILS."EventID" = COMPLIANCE."EventID" 
				WHERE COMPLIANCE."RegulatorDESCRIPTION" = 'WorkSafe Tasmania'
				   OR EVENTDETAILS."RegulatorREGULATION" = 'ZWST'  /* Look for Worksafe Tas regulator details in Event table if missing from compliance table */

			) AS WorkSafeTas ON EVENTGROUPS."EventID" = WorkSafeTas."EventID"
WHERE "EventType"  IN ('I','N')
AND "EventStatus" <> '00'
